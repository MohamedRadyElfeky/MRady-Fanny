name: Update Version JSON

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Update version.json
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_BODY: ${{ github.event.release.body }}
          ASSETS_JSON: ${{ toJson(github.event.release.assets) }}
        run: |
          import json
          import os
          import re

          # Load environment variables
          tag = os.environ['RELEASE_TAG'].replace('v', '') # Remove 'v' prefix if present
          body = os.environ['RELEASE_BODY']
          assets = json.loads(os.environ['ASSETS_JSON'])

          # Define mapping logic
          urls = {
              "android_arm64_url": None,
              "android_arm_url": None,
              "android_x86_64_url": None,
              "android_url": None,
              "windows_url": None,
              "ios_url": None
          }

          # Helper to find asset url
          def find_asset_url(keywords):
              for asset in assets:
                  name = asset['name'].lower()
                  if all(k in name for k in keywords):
                      return asset['browser_download_url']
              return None

          # Find URLs based on naming conventions
          # Android Split APKs
          urls['android_arm64_url'] = find_asset_url(['arm64-v8a', '.apk'])
          urls['android_arm_url'] = find_asset_url(['armeabi-v7a', '.apk'])
          urls['android_x86_64_url'] = find_asset_url(['x86_64', '.apk'])
          
          # Generic/Universal Android APK (fallback)
          urls['android_url'] = find_asset_url(['release', '.apk'])
          # If specific universal apk doesn't exist, try to use arm64 as default
          if not urls['android_url']:
             urls['android_url'] = urls['android_arm64_url']

          # Windows
          urls['windows_url'] = find_asset_url(['.exe'])

          # Load existing version.json
          file_path = 'version.json'
          if os.path.exists(file_path):
              with open(file_path, 'r', encoding='utf-8') as f:
                  data = json.load(f)
          else:
              data = {
                  "min_supported_version": "1.0.0",
                  "ios_url": ""
              }

          # Update data
          data['latest_version'] = tag
          data['release_notes'] = body
          
          # Only update URLs that were found
          for key, url in urls.items():
              if url:
                  data[key] = url

          # Write back to file
          with open(file_path, 'w', encoding='utf-8') as f:
              json.dump(data, f, indent=2, ensure_ascii=False)
          
          print("Updated version.json with:")
          print(json.dumps(data, indent=2))

        shell: python

      - name: Commit and Push changes
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add version.json
          git commit -m "chore: update version.json to $RELEASE_TAG"
          git push origin main
